在开始之前，先聊聊什么是守护进程
### 守护进程
> 守护进程运行在后台不受终端的影响，什么意思呢？Node.js 开发的同学们可能熟悉，当我们打开终端执行 node app.js 开启一个服务进程之后，这个终端就会一直被占用，如果关掉终端，服务就会断掉，即前台运行模式。如果采用守护进程进程方式，这个终端我执行 node app.js 开启一个服务进程之后，我还可以在这个终端上做些别的事情，且不会相互影响。参考来自五月君:[守护进程](https://www.nodejs.red/#/nodejs/process-threads?id=%e5%ae%88%e6%8a%a4%e8%bf%9b%e7%a8%8b)

PM2 运行在后台，当我们通过 PM2 去启动我们的程序之后，关闭终端，但是不管是我们的启动的程序还是 PM2，都不会因此被终止线程。这就是因为我们的程序是通过守护进程去启动的，而守护进程不会因为终端停止而停止。这时，有个很关键的问题就是，如果我们想通过 PM2 关闭或者重启我们的刚才启动的程序呢？我们没办法通过 IPC 去跟守护进程通信，因为两点，第一启动守护进程的父进程早已经关闭了，第二 在守护进程成功后父进程主动关闭了 IPC 通道。那咋办呢？IPC 通信的路子不通，我们就想想其他办法呗。

### 如何和守护进程通信

#### FOREVER 是怎么做的

我摘抄我以前在掘金上面对 [FOREVER](https://juejin.im/post/5e65fb365188254975582c95) 解读时的片段

前面我们说了，我们启动守护之后，我们就让他脱离父进程，所以我们无法通过ipc通道与子进程进行交互，同时，当我们用cli多次启动不同的应用，相当于我们有多个守护进程在运行，我们如何去管理这里守护进程，这些也是需要我们去注意的

在forever里面，有个机制，每次我们启动守护进程之后，我们会做两个步骤，第一，是将守护进程里面运行的子脚本（就是我们自己的脚本）的pid写入文件，第二，启动一个http服务器，用于socket通信

我们先讲讲第二点，这里启动http服务器，是监听socket文件，不但可以避免端口冲突，同时这个sokcet文件与pid相关，这样当我们需要跟守护进程进行通信时，我们可以通过索引、名字等等之类的找到我们需要通信的守护进程pid，然后connect到对应的socket文件，这样就可以跟守护进程进行通信了，然后就可以rm -rf / :)啦,just kidding,连上之后，我们就可以让守护进程重启、停止我们脚本的运行等等之类的骚操作了，同时守护进程也持有自身的process id ，这样我们也可以kill了守护进程。

#### PM2 是怎么做的

上面 FOREVER 已经讲得很清楚了，通过 HTTP 通信的方式去跟守护进程教程，其实 node 平台所有的 进程管理工具基本都是这样做的，不管是PM2 还是阿里的 padora.js。

不过 PM2 跟 FOREVER 不同点在于，他选择自建协议，通过也就是我们前面大费周章讲的 AMP 和 AMP-RPC 来进行通信，因为毕竟是简单地跟守护进程进行通信，不必上 HTTP 这么大的协议，这样速度和效率会更快些。

总的来说，PM2 通过 AMP-RPC 的去跟守护进程进行通信交互，从而管理我们的进程。